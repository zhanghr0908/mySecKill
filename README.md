# mySecKill
采用SpringBoot+MyBatisPlus+MySQL+Redis+RabbitMQ+Thymeleaf+JMeter简单设计了一个订单系统，主要对其进行了页面优化、接口优化和安全优化

# 项目搭建

## 技术选型

SpringBoot + MyBatis Plus+ MySQL + Redis + RabbitMQ + Thymeleaf + Jmeter

## 项目搭建

登录功能、秒杀功能、压力测试、页面优化、服务优化、安全优化

### 登录

- 明文密码两次MD5加密，参数校验和全局异常处理
- 共享session：Springsession或Redis，都是将数据存入第三方服务器中来实现分布式session
- 用户处理：将每个登录成功的用户信息在拦截器方法里放入各自的ThreadLocal中，并将用户信息存入Redis中
- 更新密码：保证数据库和内存数据一致性，采用旁路缓存模式

### 功能开发

- 商品列表页
- 商品详情页
- 秒杀功能
- 订单详情页
- 数据库表：包括用户表、商品表、订单表、秒杀商品表、秒杀订单表
- 解决超卖问题：
  - 用户id和商品id联合唯一索引，解决同一个用户秒杀多个商品的问题，即重复购买（这里也将订单信息放入Redis缓存中，以此来提高QPS并减少数据库的访问）
  - 结合事务，利用乐观锁思想优化update sql语句，防止数据库库存出现负数

### 系统压测

- JMeter单用户压测、自定义变量模拟多用户压测
- 压测对象：商品列表接口和秒杀接口

## 优化

### 页面优化

- 页面缓存、URL缓存、对象缓存（将对应的数据存放入Redis缓存中）
- 页面静态化（商品详情页静态化、秒杀页静态化、订单详情静态化），在前后端分离项目中，自动实现了页面静态化操作
- 静态资源优化（图片优化、HTML优化、CSS优化、js优化等）【未做，对前端不是很熟悉】
- CDN优化（可以将一些图片或文件等数据不要存放在数据库中，而是单独存放在一台服务器中，可以解决跨运营商和跨地域访问的问题，降低访问延时；其次就是起到了分流的作用，减轻了源站的负载；再者降低广播风暴的影响，提高网络访问的稳定性，节省主要网络带宽，减少带宽需求量）【一部分，将图片放入七牛云等服务器或采用github等作为图床】

### 接口优化

- 系统初始化后，将商品库存信息加载到Redis中，在Redis中预减库存，减少数据库的访问（Redis预减库存可以通过Redis的自增或自减原子性操作或LUA脚本来实现）
- 通过内存标记来减少Redis的访问
- RabbitMQ消息队列异步下单，客户端通过轮询数据库或Redis来得到下单结果（推荐采用去Redis轮询），增强用户体验
- Redis分布式锁
  - setnx
  - set nx ex
  - 使用UUID防止误删锁
  - 使用LUA脚本保证删除操作原子性

### 安全优化

- 秒杀接口地址隐藏：当点击立即秒杀按钮后，会先去生成当前用户唯一秒杀路径，再去进行秒杀操作，防止脚本操作。但如果知道路径拼接规则还是可以通过脚本来频繁秒杀
- 验证码：不要采用简单的输入字符或数字的验证码，采用数学运算、点击文字顺序等验证码，来防止机器操作，同时也可以减缓脚本的刷新速度
- 接口防刷限流：
  - 计数器算法：采用AOP思想，自定义注解+拦截器去实现频率控制，简单方便，但是存在临界问题和资源浪费的情况，不过本项目是简单模拟，就没有采取更高深的接口防刷限流
  - 漏斗算法
  - 令牌桶算法
  - 微服务的网关限流操作等，比如gateway、zuul等

## QPS

QPS的瓶颈在于：对数据库数据的操作频繁读取，变更较少

数据库的访问优化包含两方面：1-减少数据库的访问（缓存）；2-增强数据库的功能（mycat等分库分表），本项目只做了第一种方案

由于个人买的服务器配置较低，所以在Windows操作系统下进行JMeter压测，得到的QPS如下

- 商品列表接口
  - 优化前：1332
  - 页面优化后：2342（从1332->2342，提升了75.8%）
- 秒杀接口
  - 优化前：785
  - 页面优化后：1286（从785->1286，提升了63.8%）
  - 接口优化后：2454（从1286->2454，提升了90.8%）